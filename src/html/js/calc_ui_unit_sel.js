
// TODO remove
// only putting this here for now until I figure out a good way
// to get this information from the calc worker thread
const UNIT_INFO_TREE_ALL = 
{
  "group_name": "root",
  "child_groups": [
    {
      "group_name": "Distance",
      "child_groups": [],
      "child_units": [
        {
          "nice_name": "metre",
          "unit_names": [
            [
              {
                "name": "m",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "lightyear",
          "unit_names": [
            [
              {
                "name": "ly",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "astronomical unit",
          "unit_names": [
            [
              {
                "name": "au",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "parsec",
          "unit_names": [
            [
              {
                "name": "pc",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "inch",
          "unit_names": [
            [
              {
                "name": "in",
                "pow": 1
              }
            ],
            [
              {
                "name": "inch",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "foot",
          "unit_names": [
            [
              {
                "name": "ft",
                "pow": 1
              }
            ],
            [
              {
                "name": "feet",
                "pow": 1
              }
            ],
            [
              {
                "name": "foot",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "yard",
          "unit_names": [
            [
              {
                "name": "yard",
                "pow": 1
              }
            ],
            [
              {
                "name": "yd",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "mile",
          "unit_names": [
            [
              {
                "name": "mile",
                "pow": 1
              }
            ],
            [
              {
                "name": "mi",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "nautical mile",
          "unit_names": [
            [
              {
                "name": "nmi",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        }
      ]
    },
    {
      "group_name": "Area",
      "child_groups": [],
      "child_units": [
        {
          "nice_name": "square metre",
          "unit_names": [
            [
              {
                "name": "m",
                "pow": 2
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "hectare",
          "unit_names": [
            [
              {
                "name": "ha",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "acre",
          "unit_names": [
            [
              {
                "name": "acre",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "square inches",
          "unit_names": [
            [
              {
                "name": "in",
                "pow": 2
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "square feet",
          "unit_names": [
            [
              {
                "name": "ft",
                "pow": 2
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "square yard",
          "unit_names": [
            [
              {
                "name": "yd",
                "pow": 2
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "square miles",
          "unit_names": [
            [
              {
                "name": "mi",
                "pow": 2
              }
            ]
          ],
          "si_prefixable": false
        }
      ]
    },
    {
      "group_name": "Volume",
      "child_groups": [],
      "child_units": [
        {
          "nice_name": "cubic metre",
          "unit_names": [
            [
              {
                "name": "m",
                "pow": 3
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "Litre",
          "unit_names": [
            [
              {
                "name": "L",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "teaspoon",
          "unit_names": [
            [
              {
                "name": "tsp",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "tablespoon",
          "unit_names": [
            [
              {
                "name": "tbsp",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "fluid ounce",
          "unit_names": [
            [
              {
                "name": "floz",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "cup",
          "unit_names": [
            [
              {
                "name": "cup",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "gallon",
          "unit_names": [
            [
              {
                "name": "gallon",
                "pow": 1
              }
            ],
            [
              {
                "name": "gal",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "quart",
          "unit_names": [
            [
              {
                "name": "quart",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "pint",
          "unit_names": [
            [
              {
                "name": "pint",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "cubic inches",
          "unit_names": [
            [
              {
                "name": "in",
                "pow": 3
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "cubic feet",
          "unit_names": [
            [
              {
                "name": "ft",
                "pow": 3
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "cubic yard",
          "unit_names": [
            [
              {
                "name": "yd",
                "pow": 3
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "cubic miles",
          "unit_names": [
            [
              {
                "name": "mi",
                "pow": 3
              }
            ]
          ],
          "si_prefixable": false
        }
      ]
    },
    {
      "group_name": "Time",
      "child_groups": [],
      "child_units": [
        {
          "nice_name": "second",
          "unit_names": [
            [
              {
                "name": "s",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "minute",
          "unit_names": [
            [
              {
                "name": "minute",
                "pow": 1
              }
            ],
            [
              {
                "name": "min",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "hour",
          "unit_names": [
            [
              {
                "name": "hr",
                "pow": 1
              }
            ],
            [
              {
                "name": "hour",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "day",
          "unit_names": [
            [
              {
                "name": "day",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "month",
          "unit_names": [
            [
              {
                "name": "month",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "year",
          "unit_names": [
            [
              {
                "name": "year",
                "pow": 1
              }
            ],
            [
              {
                "name": "yr",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        }
      ]
    },
    {
      "group_name": "Speed",
      "child_groups": [],
      "child_units": [
        {
          "nice_name": "metres per second",
          "unit_names": [
            [
              {
                "name": "m",
                "pow": 1
              },
              {
                "name": "s",
                "pow": -1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "kilometres per hour",
          "unit_names": [
            [
              {
                "name": "km",
                "pow": 1
              },
              {
                "name": "hr",
                "pow": -1
              }
            ],
            [
              {
                "name": "kph",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "miles per hour",
          "unit_names": [
            [
              {
                "name": "mph",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "feet per second",
          "unit_names": [
            [
              {
                "name": "ft",
                "pow": 1
              },
              {
                "name": "s",
                "pow": -1
              }
            ]
          ],
          "si_prefixable": false
        }
      ]
    },
    {
      "group_name": "Pressure",
      "child_groups": [],
      "child_units": [
        {
          "nice_name": "Pascal",
          "unit_names": [
            [
              {
                "name": "Pa",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "atmosphere",
          "unit_names": [
            [
              {
                "name": "atm",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "torr",
          "unit_names": [
            [
              {
                "name": "torr",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "mm Hg",
          "unit_names": [
            [
              {
                "name": "mmHg",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "pounds per square inch",
          "unit_names": [
            [
              {
                "name": "psi",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "cm H2O",
          "unit_names": [
            [
              {
                "name": "cmH2O",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "mm H2O",
          "unit_names": [
            [
              {
                "name": "mmH2O",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        }
      ]
    },
    {
      "group_name": "Mass/Force",
      "child_groups": [],
      "child_units": [
        {
          "nice_name": "gram",
          "unit_names": [
            [
              {
                "name": "g",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "Newton",
          "unit_names": [
            [
              {
                "name": "N",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "metric ton",
          "unit_names": [
            [
              {
                "name": "ton",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "pound (mass)",
          "unit_names": [
            [
              {
                "name": "lb",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "pound (force)",
          "unit_names": [
            [
              {
                "name": "lbf",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "ounce",
          "unit_names": [
            [
              {
                "name": "oz",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "slug",
          "unit_names": [
            [
              {
                "name": "slug",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        }
      ]
    },
    {
      "group_name": "Energy/Electricity/Frequency",
      "child_groups": [],
      "child_units": [
        {
          "nice_name": "Hertz",
          "unit_names": [
            [
              {
                "name": "Hz",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "Joule (Energy)",
          "unit_names": [
            [
              {
                "name": "J",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "electron Volt",
          "unit_names": [
            [
              {
                "name": "eV",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "calorie",
          "unit_names": [
            [
              {
                "name": "cal",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "kilocalorie",
          "unit_names": [
            [
              {
                "name": "kcal",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },

        {
          "nice_name": "British thermal unit",
          "unit_names": [
            [
              {
                "name": "btu",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "Watt (Power)",
          "unit_names": [
            [
              {
                "name": "W",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "horsepower",
          "unit_names": [
            [
              {
                "name": "hp",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": false
        },
        {
          "nice_name": "Volt (Voltage)",
          "unit_names": [
            [
              {
                "name": "V",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "Amp (Current)",
          "unit_names": [
            [
              {
                "name": "A",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "Ohm (Resistance)",
          "unit_names": [
            [
              {
                "name": "Ohm",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "Coulomb (Charge)",
          "unit_names": [
            [
              {
                "name": "C",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "Siemen (Conductance)",
          "unit_names": [
            [
              {
                "name": "S",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "Tesla",
          "unit_names": [
            [
              {
                "name": "T",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "Webber",
          "unit_names": [
            [
              {
                "name": "Wb",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "Henry (Inductance)",
          "unit_names": [
            [
              {
                "name": "H",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "Farad (Capacitance)",
          "unit_names": [
            [
              {
                "name": "F",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        }
      ]
    },
    {
      "group_name": "Miscellaneous",
      "child_groups": [],
      "child_units": [
        {
          "nice_name": "Kelvin (Temperature)",
          "unit_names": [
            [
              {
                "name": "K",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "moles",
          "unit_names": [
            [
              {
                "name": "mol",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "candella",
          "unit_names": [
            [
              {
                "name": "cd",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "Gray",
          "unit_names": [
            [
              {
                "name": "Gy",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        },
        {
          "nice_name": "Sievert",
          "unit_names": [
            [
              {
                "name": "Sv",
                "pow": 1
              }
            ]
          ],
          "si_prefixable": true
        }
      ]
    }
  ],
  "child_units": []
};

function init_unit_sel_state() {
	return {
		unit_category_selector_visible: true,
		selected_si_prefix: -1,
		//selected_unit_info: null,
		recently_used_units: [],
	};
}

const SI_PREFIXES = [
	{ pow:  24, prefix: "Y",  prefix_name: "yotta" },
	{ pow:  21, prefix: "Z",  prefix_name: "zetta" },
	{ pow:  18, prefix: "E",  prefix_name: "exa"   },
	{ pow:  15, prefix: "P",  prefix_name: "peta"  },
	{ pow:  12, prefix: "T",  prefix_name: "tera"  },
	{ pow:   9, prefix: "G",  prefix_name: "giga"  },
	{ pow:   6, prefix: "M",  prefix_name: "mega"  },
	{ pow:   3, prefix: "k",  prefix_name: "kilo"  },
	{ pow:   2, prefix: "h",  prefix_name: "hecto" },
	{ pow:   1, prefix: "da", prefix_name: "deca"  },
	{ pow:   0, prefix: "",   prefix_name: ""      },
	{ pow:  -1, prefix: "d",  prefix_name: "deci"  },
	{ pow:  -2, prefix: "c",  prefix_name: "centi" },
	{ pow:  -3, prefix: "m",  prefix_name: "milli" },
	{ pow:  -6, prefix: "u",  prefix_name: "micro" },
	{ pow:  -9, prefix: "n",  prefix_name: "nano"  },
	{ pow: -12, prefix: "p",  prefix_name: "pico"  },
	{ pow: -15, prefix: "f",  prefix_name: "femto" },
	{ pow: -18, prefix: "a",  prefix_name: "atto"  },
	{ pow: -21, prefix: "z",  prefix_name: "zepto" },
	{ pow: -24, prefix: "y",  prefix_name: "yocto" },
];

const POW_STRS = [
];

for (let i=10; i>=-10; i--) {
	if (i == 0) { continue; }
	POW_STRS.push( "" + i);
}

function get_pow_zero_idx() {
	for (let i=0; i<POW_STRS.length; i++) {
		if (POW_STRS[i] == "1") {
			return i;
		}
	}
	throw "pow str zero idx not found";
}

function get_html_prefix(prefix) {
	if (prefix == "u") {
		return "&micro;"
	} else {
		return prefix;
	}
}

function si_prefix_dropdown_option_txt(i) {
	let info = SI_PREFIXES[i];
	let prefix_display;
	if (info.prefix.length > 0) {
		prefix_display = info.prefix;
	} else {
		prefix_display = "(no prefix)";
	}
	let str = prefix_display + ", 10^" + info.pow;
	if (info.prefix_name.length > 0) {
		str += " (" + info.prefix_name + ")";
	}
	return str;
}

function get_si_prefix_zero_idx() {
	for (let i=0; i<SI_PREFIXES.length; i++) {
		if (SI_PREFIXES[i].pow == 0) { return i; }
	}
	throw "zero idx not found";
}

function UnitItemInfo_group(group_name, children_elem, link_item) {
	return {
		is_group:   true,
		group_name: group_name,
		is_expanded:   false,
		children_elem: children_elem,
		link_item:     link_item,
	};
}

function UnitItemInfo_item(unit) {
	return {
		is_group:  false,
		nice_name: unit.nice_name,
		units:     unit.unit_names,
		si_prefixable:     unit.si_prefixable,
	};
}

function build_group_elem(ui_unit_sel, group_name, elem_id) {
	let elem = document.createElement("li");
	let elem2 = document.createElement("a");
	elem2.href = "#";
	elem.appendChild(elem2);
	elem2.classList.add("unit_sel_item");
	elem2.id = elem_id;
	elem2.addEventListener('click', group_clicked_handler_factory(ui_unit_sel));
	return { list_item: elem, link_item: elem2 };
}

function build_unit_elem(ui_unit_sel, nice_name, elem_id) {
	let elem = document.createElement("li");
	let elem2 = document.createElement("a");
	elem2.classList.add("unit_sel_item");
	elem2.href = "#";
	elem2.id = elem_id;
	let txtElem = document.createTextNode(nice_name);
	elem2.appendChild(txtElem);
	elem2.addEventListener('click', unit_clicked_handler_factory(ui_unit_sel));
	elem.appendChild(elem2);
	return elem;
}

function update_group_link_text(item_info) {
	let collapsed_icon;
	if (item_info.is_expanded) {
		item_info.children_elem.style.display = "";
		collapsed_icon = "-";
	} else {
		collapsed_icon = "+";
		item_info.children_elem.style.display = "none";
	}
	let text = "<span style=\"font-family:monospace\" class=\"no_click_handling\">[" + collapsed_icon + "]</span>";
	text += "" + item_info.group_name;
	item_info.link_item.innerHTML = text;
}

function group_clicked_handler_factory(ui_unit_sel) {
	return function (e) {
		let elem = e.target;
		let item_info = ui_unit_sel.unit_sel_map[elem.id];
		console.assert(item_info.is_group);
		item_info.is_expanded = !item_info.is_expanded;
		update_group_link_text(item_info);
	};
}

function unit_clicked_handler_factory(ui_unit_sel) {
	return function (e) {
		let elem = e.target;
		let item_info = ui_unit_sel.unit_sel_map[elem.id];
		console.log("looked up elem.id", elem.id, "found info:", item_info);
		//ui_unit_sel.state.selected_unit_info = item_info;
		enter_unit_adjustment(ui_unit_sel, item_info);
	}
}

// make either pane visible:
//   - category_sel == false: unit category selection, or
//   - category_sel == true:  unit adjuster
//
// If category_sel is false, must supply units argument

function set_pane_unit_sel(ui_unit_sel, category_sel, units) {
	let cat_sel_display;
	let adjust_display;
	let insert_btn_enabled;
	ui_unit_sel.category_sel_visible = category_sel;
	if (category_sel) {
		cat_sel_display = "";
		adjust_display = "none";
		destruct_unit_base_sel(ui_unit_sel);
	} else {
		cat_sel_display = "none";
		adjust_display = "";
		init_unit_base_sel(ui_unit_sel, units);
	}

	ui_unit_sel.unit_category_selector_visible = category_sel;
	ui_unit_sel.unit_category_selector.style.display = cat_sel_display;
	ui_unit_sel.unit_adjuster.style.display          = adjust_display;
	update_unit_insert_btn_enabled(ui_unit_sel);
}

function update_unit_insert_btn_enabled(ui_unit_sel) {
	let insert_btn_enabled;
	insert_btn_enabled = !ui_unit_sel.category_sel_visible ||
	                     ui_unit_sel.currently_highlighted != null;

	ui_unit_sel.btn_unit_display_insert.disabled = !insert_btn_enabled;
}

// This is kind of ugly right now...
// If a unit has a number of variants (e.g. "km hr^-1", "kph")
// then only allow the user to adjust the power of the unit if
// all variants are a single unit factor with no non default pow.
//
// This means that "m^2" won't allow the user to adjust the exponent, but "m" does.
//
// Maybe a better future way is to check if there is only one unit variant,
// which is only one unit factor, then allow the power to be changed--
// but then the power will have to be initialized to whatever the unit_info
// specifies the power should be
function unit_can_adjust_pow(unit_info) {
	console.log(unit_info);
	for (let unit_variant of unit_info.units) {
		let can_adjust_pow = (unit_variant.length == 1 &&
		                     unit_variant[0].pow == 1);
		if (!can_adjust_pow) { return false; }
	}
	return true;
}

function enter_unit_adjustment(ui_unit_sel, item_info) {
	console.debug("enter unit adjustment", item_info);
	set_pane_unit_sel(ui_unit_sel, false, item_info.units);
	dropdown_and_inc_set_enabled(ui_unit_sel.prefix_dropdown_widget, item_info.si_prefixable);
	dropdown_and_inc_reset_sel(ui_unit_sel.prefix_dropdown_widget);
	dropdown_and_inc_reset_sel(ui_unit_sel.pow_dropdown_widget);
	dropdown_and_inc_set_enabled(ui_unit_sel.pow_dropdown_widget, unit_can_adjust_pow(item_info));
	dropdown_and_inc_reset_sel(ui_unit_sel.base_dropdown_widget);
}

function build_unit_sel_tree(ui_unit_sel, unit_groups) {
	let children = [];
	for (let group of unit_groups.child_groups) {
		let elem_id = "unit_sel_item_" + ui_unit_sel.item_id;
		ui_unit_sel.item_id += 1;
		let elems = build_group_elem(ui_unit_sel, group.group_name, elem_id);
		let elem = elems.list_item;
		let child_children = build_unit_sel_tree(ui_unit_sel, group);
		let children_elem = null;
		if (child_children.length > 0) {
			children_elem = document.createElement("ul");
			// will be set to display:none in update_group_link_text
			elem.appendChild(children_elem);
			for (let child2 of child_children) {
				children_elem.appendChild(child2);
			}
		}
		let item_info = UnitItemInfo_group(group.group_name, children_elem, elems.link_item);

		// expand a group if it is the only one, or
		// if it only has one child (likely only after filtering)
		// TODO move this somewhere outside the group?
		// TODO also expand everything if the total filtered tree
		// contains fewer than 10 or so units? (if it can fit comfortably after
		// at most a tiny bit of scrolling)
		if (unit_groups.child_groups.length == 1 ||
		    child_children.length == 1) {
			item_info.is_expanded = true;
		}

		update_group_link_text(item_info);
		ui_unit_sel.unit_sel_map[elem_id] = item_info;
		children.push(elem);
	}

	for (let unit of unit_groups.child_units) {
		let elem_id = "unit_sel_item_" + ui_unit_sel.item_id;
		ui_unit_sel.item_id += 1;
		let elem = build_unit_elem(ui_unit_sel, unit.nice_name, elem_id);
		ui_unit_sel.unit_sel_map[elem_id] = UnitItemInfo_item(unit);
		children.push(elem);
	}

	return children;
}

function unit_factor_to_html(unit) {
	let html_out = unit.name;
	if (unit.pow != 1) {
		html_out += "<sup>" + unit.pow + "</sup>";
	}
	return html_out;
}

function unit_factor_to_txt(unit) {
	let txt_out = unit.name;
	if (unit.pow != 1) {
		txt_out += "^" + unit.pow;
	}
	return txt_out;
}

function join_str(ary, sep) {
	let out_str = "";
	let first = true;
	for (let elem of ary) {
		if (!first) {
			out_str += sep;
		}
		first = false;
		out_str += elem;
	}
	return out_str;
}

function foreach_call(ary, func) {
	let out = [];
	for (let elem of ary) {
		out.push(func(elem));
	}
	return out;
}

function unit_to_html(unit_info) {
	console.log("unit_to_html", unit_info);
	let unit_str_ary = foreach_call(unit_info, unit_factor_to_html);
	let out_str = join_str(unit_str_ary, " ");
	console.log(out_str);
	return out_str;
}

function unit_to_txt(unit_info) {
	console.log("unit_to_txt", unit_info);
	let unit_str_ary = foreach_call(unit_info, unit_factor_to_txt);
	let out_str = join_str(unit_str_ary, " ");
	console.log(out_str);
	return out_str;
}

function init_unit_base_sel(ui_unit_sel, units) {

	let get_output_val = function() {
		let idx = ui_unit_sel.base_dropdown_widget.select_idx;
		console.log("[alex] get_output_val", idx);
		return unit_to_txt(units[idx]);
	};

	ui_unit_sel.base_dropdown_widget = {
		name: "unit_base",
		init_select_idx: 0,
		select_idx:      undefined,
		choice_count:    units.length,
		select:          ui_unit_sel.unit_adjuster_base_select,
		btn_inc:         ui_unit_sel.base_inc_btn,
		btn_dec:         ui_unit_sel.base_dec_btn,
		display:         ui_unit_sel.unit_adjuster_base_val,
		get_display_val: function (idx) {
			return unit_to_html(units[idx]);
		},
		get_output_val: get_output_val,
	};

	dropdown_set_select_options(ui_unit_sel.base_dropdown_widget,
	                            function (i) { return unit_to_txt(units[i]); });
	init_dropdown_and_inc_widget(ui_unit_sel.base_dropdown_widget);
}


function destruct_unit_base_sel(ui_unit_sel) {
	destruct_dropdown_and_inc_widget(ui_unit_sel.base_dropdown_widget);
}

function init_unit_prefix_sel(ui_unit_sel) {

	ui_unit_sel.prefix_dropdown_widget = {
		name: "unit_prefix",
		init_select_idx: get_si_prefix_zero_idx(),
		select_idx: undefined, // set by init_dropdown_and_inc_widget,
		                       // and when user presses buttons or dropdown
		choice_count: SI_PREFIXES.length,
		select:  ui_unit_sel.si_prefix_select,
		btn_inc: ui_unit_sel.si_prefix_inc_btn,
		btn_dec: ui_unit_sel.si_prefix_dec_btn,
		display: ui_unit_sel.unit_adjuster_prefix_val,
		// called by the widget to update the display
		get_display_val: function (idx) {
			let prefix = SI_PREFIXES[idx].prefix;
			html_prefix = get_html_prefix(prefix);
			return html_prefix;
		},

		// called outside of this widget to determine which prefix the user has selected 
		get_output_val: null,
	};

	ui_unit_sel.prefix_dropdown_widget.get_output_val = function () {
		let idx = ui_unit_sel.prefix_dropdown_widget.select_idx;
		return SI_PREFIXES[idx].prefix;
	};

	dropdown_set_select_options(ui_unit_sel.prefix_dropdown_widget,
	                            si_prefix_dropdown_option_txt);

	init_dropdown_and_inc_widget(ui_unit_sel.prefix_dropdown_widget);
}

function init_unit_pow_sel(ui_unit_sel) {
	ui_unit_sel.pow_dropdown_widget = {
		name:             "unit_pow",
		init_select_idx:  get_pow_zero_idx(),
		select_idx:       undefined,
		choice_count:     POW_STRS.length,
		select:           ui_unit_sel.unit_pow_select,
		btn_inc:          ui_unit_sel.unit_pow_btn_inc,
		btn_dec:          ui_unit_sel.unit_pow_btn_dec,
		display:          ui_unit_sel.unit_pow_display,
		get_display_val: function (idx) {
			let str = POW_STRS[idx];
			if (str != "1" ) {
				return str;
			} else {
				return "&nbsp;"
			}
		},
		get_output_val:  null,
	};
	ui_unit_sel.pow_dropdown_widget.get_output_val = function () {
		let idx = ui_unit_sel.pow_dropdown_widget.select_idx;
		return POW_STRS[idx];
	};

	dropdown_set_select_options(ui_unit_sel.pow_dropdown_widget,
	                            function (idx) { return POW_STRS[idx]; });
	init_dropdown_and_inc_widget(ui_unit_sel.pow_dropdown_widget);
}

function get_selected_unit_adjuster(ui_unit_sel) {
	let prefix = dropdown_get_selected_val(ui_unit_sel.prefix_dropdown_widget);
	let base   = dropdown_get_selected_val(ui_unit_sel.base_dropdown_widget);
	let pow    = dropdown_get_selected_val(ui_unit_sel.pow_dropdown_widget);
	console.debug( "user selected prefix:", prefix, "base:", base, "pow:", pow);
	
	let str = prefix + base;
	if (pow.length > 0 && pow != "1") {
		str += "^" + pow;
	}
	return str;
}

function get_selected_unit_recently_used(ui_unit_sel) {
	let row = ui_unit_sel.currently_highlighted;
	console.assert(ui_unit_sel.row_info_map.has(row));
	let unit_info = ui_unit_sel.row_info_map.get(row);
	console.assert(unit_info);
	return unit_info;
}

function handle_insert_unit_btn_clicked(ui_unit_sel) {
	let unit;
	if (ui_unit_sel.currently_highlighted == null) {
		unit = get_selected_unit_adjuster(ui_unit_sel);
		console.log("Inserting unit from adjuster:", unit);
	} else {
		unit = get_selected_unit_recently_used(ui_unit_sel);
		console.log("Inserting unit from recently used:", unit);
	}
	// Add one space at the beginning, to avoid
	// concatenating unit "m" and unit "s" resulting in "ms"
	let unit_token = " " + unit;
	ui_unit_sel.on_insert_unit_btn_pressed(unit_token);
	update_recently_used_units(ui_unit_sel, [unit]);
	ui_unit_sel.highlight_recently_used_unit(ui_unit_sel, null);

	set_pane_unit_sel(ui_unit_sel, true);
}

function merge_units_remove_duplicates(old_units, new_units) {

	// ffs why is += not concatenate here? Instead it concatenates the contents???

	//let all_units = old_units.concat(new_units);
	// put new units at beginning
	let all_units = new_units.concat(old_units);

	let to_return = [];
	let seen_units = new Map();
	for (let unit of all_units) {
		if (seen_units.has(unit)) { continue; }
		seen_units.set(unit, true);
		to_return.push(unit);
	}
	return to_return;

}

// public API
function update_recently_used_units(ui_unit_sel, new_units) {
	/*
	ui_unit_sel.state.recently_used_units =
	    merge_units_remove_duplicates(ui_unit_sel.state.recently_used_units, new_units);
	*/
	ui_unit_sel.state.recently_used_units = new_units;
	console.debug("Recently used units now:", ui_unit_sel.state.recently_used_units);
	ui_unit_sel.set_recently_used_units(ui_unit_sel, ui_unit_sel.state.recently_used_units);
}

function handle_recently_used_unit_btn_pressed(ui_unit_sel, row) {
	ui_unit_sel.highlight_recently_used_unit(ui_unit_sel, row);
	update_unit_insert_btn_enabled(ui_unit_sel);
}

// Should return true for str "abc/def (test/blah)"
// for any args "abc", "def", "test", "blah" or any of their
// first 1 to n letters, but not "bc" or any of their substrings
function any_word_startswith(str, filter_expr) {
	str = str.replace(/[()\/]/g, " ");
	str = str.split(" ");
	for (let word of str) {
		if (word.trim().length == 0) { continue; }
		if (word.startsWith(filter_expr)) {
			return true;
		}
	}
	return false;
}

// only returns true if there is a match, not if the filter expr is empty
// if this retruns true, should include all units in the group instead of submatching
// e.g. the user might type "distance" and want to see all the options
function filter_expr_match_group_name(group_name, filter_expr) {
	group_name = group_name.toLowerCase();
	filter_expr = filter_expr.toLowerCase();

	return any_word_startswith(group_name, filter_expr);
}

// Returns true if nice name contains filter_expr,
// or if any unit starts with filter_expr
function filter_expr_match_unit(unit_info, filter_expr) {
	if (filter_expr.trim().length == 0) {
		return true;
	}

	filter_expr = filter_expr.toLowerCase();


	// TODO need to handle searching for either "metre" or "meter",
	// maybe just add both as possible long unit names

	// TODO also want "oz" to return both "fl oz" and "oz". Not sure how.
	// This works for "ounce" because it's in the nice name.
	// Seems like I want to have multiple nice names that alias to the same
	// thing.
	// Maybe if there are no matches, then default to searching any substring
	// of the unit names?

	//if (unit_info.nice_name.toLowerCase().search(filter_expr) != -1) {
	if (filter_expr_match_group_name(unit_info.nice_name.toLowerCase(), filter_expr)) {
		return true;
	}

	// TODO might want to do something if si prefixable, check if any of the prefixes
	// are present in the search?
	// i.e. user should be able to type "kg" or "kilogram"
	//
	// if user types "kilo" or "k", should
	// maybe show all SI prerixable units.
	// Only do this if a "enable SI prefixes in filter" checkbox is checked
	// If user types "k" then should only show units starting with "k" like "Kelvin"


	for (let unit_names of unit_info.unit_names) {
		for (let unit_elem of unit_names) {
			if (unit_elem.name.toLowerCase().startsWith(filter_expr)) {
				return true;
			}
		}
	}

	return false;
}

function filter_unit_tree(unit_info_node, filter_expr) {
	let new_unit_info_node = {};
	new_unit_info_node.group_name = unit_info_node.group_name;
	new_unit_info_node.child_groups = [];
	new_unit_info_node.child_units  = [];

	for (let child of unit_info_node.child_groups) {
		let filtered_child;
		// if group name matches, don't do any filtering.
		// e.g. if user types "distance", show the entire unfiltered distance category
		if (filter_expr_match_group_name(child.group_name, filter_expr)) {
			filtered_child = child;
		} else {
			filtered_child = filter_unit_tree(child, filter_expr);
		}

		if (filtered_child.child_groups.length > 0 ||
		    filtered_child.child_units.length > 0) {
			new_unit_info_node.child_groups.push(filtered_child);
		}
	}

	for (let child of unit_info_node.child_units) {
		if (filter_expr_match_unit(child, filter_expr)) {
			new_unit_info_node.child_units.push(child);
		}
	}

	return new_unit_info_node;
}

function set_unit_sel_categories(ui_unit_sel, filter_expr) {
	if (filter_expr == undefined) {
		filter_expr = "";
	}
	let ui_tree = ui_unit_sel.unit_sel_tree;

	while (ui_tree.firstChild) {
		ui_tree.removeChild(ui_tree.firstChild);
	}

	let unit_info_tree = filter_unit_tree(UNIT_INFO_TREE_ALL, filter_expr);
	console.log("Filtered with expr", filter_expr, ":", unit_info_tree);

	let child_unit_groups = build_unit_sel_tree(ui_unit_sel, unit_info_tree);
	for (let child of child_unit_groups) {
		ui_tree.appendChild(child);
	}
}

function handle_filter_text_update(ui_unit_sel, filter_text) {
	set_unit_sel_categories(ui_unit_sel, filter_text);
}

function add_recently_used_unit_row_click_listener(ui_unit_sel, row, var_name) {
	row.addEventListener('click', function (e) {
		handle_recently_used_unit_btn_pressed(ui_unit_sel, row);
	});
	ui.state.new_var_btns_map.set(row, var_name);
}


// public API
function calc_ui_unit_sel_set_visible(ui_unit_sel, is_visible) {
	if (is_visible) {
		ui_unit_sel.root.style.display="";
	} else {
		ui_unit_sel.root.style.display="none";

		// clear UI state when being closed?
		ui_unit_sel.highlight_recently_used_unit(ui_unit_sel, null);
		set_pane_unit_sel(ui_unit_sel, true);
	}
}

// called once at html init,
// initializes SI prefixes and powers as they don't change.
// unit base is initialized upon unit selection, since it's different for every
// unit.
// public API
function init_unit_sel(ui_unit_sel) {
	ui_unit_sel.state = init_unit_sel_state();
	ui_unit_sel.item_id = 0;

	set_unit_sel_categories(ui_unit_sel);

	ui_unit_sel.back_to_unit_cat.addEventListener('click', function (e) { set_pane_unit_sel(ui_unit_sel, true); } );
	ui_unit_sel.btn_unit_display_insert.addEventListener('click', function (e) { handle_insert_unit_btn_clicked(ui_unit_sel) } );

	init_unit_prefix_sel(ui_unit_sel);
	init_unit_pow_sel(ui_unit_sel);

	ui_unit_sel.unit_list_filter.addEventListener('input', function (e) {
		let filter_text = ui_unit_sel.unit_list_filter.value;
		handle_filter_text_update(ui_unit_sel, filter_text);
	});
}
